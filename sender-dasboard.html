<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sender Dashboard | FikaConnect</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    
    <link rel="stylesheet" href="styles.css" />
</head>

   <style>
    :root {
      --bg-light: #f4f4f4;
      --bg-dark: #121212;
      --text-light: #fff;
      --text-dark: #222;
      --primary: #198754;
      --card-light: #fff;
      --card-dark: #1e1e1e;
    }

    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-dark);
      transition: background 0.3s, color 0.3s;
    }

    body.dark-mode {
      background-color: var(--bg-dark);
      color: var(--text-light);
    }

    .menu-toggle {
      position: fixed;
      top: 20px;
      left: 20px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 1.2rem;
      cursor: pointer;
      z-index: 1100;
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: transparent;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      color: var(--primary);
      z-index: 1100;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100%;
      background-color: var(--card-light);
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar.dark-mode {
      background-color: var(--card-dark);
    }

    .sidebar-header h2 {
      color: var(--primary);
      margin-bottom: 0;
    }

    .sidebar-header p {
      font-size: 0.9rem;
    }

    .sidebar-nav ul {
      list-style: none;
      padding: 0;
    }

    .sidebar-nav li {
      margin: 15px 0;
    }

    .sidebar-nav a {
      text-decoration: none;
      color: inherit;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background-color 0.2s;
    }

    .sidebar-nav a:hover, .sidebar-nav a.active {
      background-color: var(--primary);
      color: #fff;
    }

    .sidebar-footer {
      margin-top: 30px;
      border-top: 1px solid #ccc;
      padding-top: 15px;
    }

    .main-content {
      margin-left: 0;
      padding: 20px;
      transition: margin-left 0.3s;
    }

    .dashboard-header h2 {
      margin-bottom: 5px;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .stat-card {
      background-color: var(--card-light);
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      transition: background 0.3s;
    }

    .dark-mode .stat-card {
      background-color: var(--card-dark);
    }

    .stat-card .icon {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.4);
      display: none;
      z-index: 900;
    }

    .overlay.active {
      display: block;
    }

    .page-footer {
      text-align: center;
      margin-top: 50px;
      font-size: 0.9em;
    }

    @media (min-width: 992px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <button class="menu-toggle" id="menuToggle">
    <i class="fas fa-bars"></i>
  </button>
  <button class="theme-toggle" id="themeToggle">
    <i class="fas fa-moon"></i>
  </button>

  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h2>FikaConnect</h2>
      <p>Sender Dashboard</p>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li><a href="#" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="book adelivery.html"><i class="fas fa-plus-circle"></i> Book New</a></li>
        <li><a href="#"><i class="fas fa-user-circle"></i> My Profile</a></li>
        <li><a href="#"><i class="fas fa-history"></i> My History</a></li>
        <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
        <li><a href="#"><i class="fas fa-headset"></i> Contact Us</a></li>
        <li><a href="about.html"><i class="fas fa-info-circle"></i> About Us</a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <a href="#" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
  </aside>

  <div class="overlay" id="overlay"></div>

  <div class="main-content">
    <div class="dashboard-header">
      <h2>Welcome, <span id="userNameDisplay">Sender</span>!</h2>
      <p>Your FikaConnect dashboard for managing deliveries.</p>
    </div>

    <div class="dashboard-actions">
      <a href="book adelivery.html" class="primary-btn"><i class="fas fa-plus-circle"></i> Book New Delivery</a>
    </div>

    <div class="dashboard-stats">
      <div class="stat-card">
        <i class="icon fas fa-hourglass-half"></i>
        <h3><span id="pendingDeliveriesCount">0</span></h3>
        <p>Pending / In Progress</p>
      </div>
      <div class="stat-card">
        <i class="icon fas fa-check-circle"></i>
        <h3><span id="completedDeliveriesCount">0</span></h3>
        <p>Completed Deliveries</p>
      </div>
      <div class="stat-card">
        <i class="icon fas fa-money-bill-wave"></i>
        <h3>UGX <span id="totalSpendAmount">0</span></h3>
        <p>Total Spent</p>
      </div>
    </div>

   <div class="deliveries-section">
      <h3><i class="fas fa-truck-moving"></i> My Deliveries</h3>
      <p>View the status of your active deliveries and track them in real-time.</p>
      <a href="sender-active-deliveries.html" class="primary-btn view-deliveries-btn">
        <i class="fas fa-eye"></i> View All My Deliveries
      </a>
      </div>

    <footer class="page-footer">
      <p>&copy; 2025 FikaConnect — Smart Logistics for East Africa</p>
    </footer>
  </div>

  <script>
    const menuToggle = document.getElementById("menuToggle");
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");
    const themeToggle = document.getElementById("themeToggle");
    const body = document.body;

    menuToggle.addEventListener("click", () => {
      sidebar.classList.toggle("open");
      overlay.classList.toggle("active");
    });

    overlay.addEventListener("click", () => {
      sidebar.classList.remove("open");
      overlay.classList.remove("active");
    });

    themeToggle.addEventListener("click", () => {
      body.classList.toggle("dark-mode");
      sidebar.classList.toggle("dark-mode");
      const icon = themeToggle.querySelector("i");
      icon.classList.toggle("fa-moon");
      icon.classList.toggle("fa-sun");
    });
  </script>
</main>
<script type="module">
  'use strict';

  // ✅ Import Firebase modules at the top level — not inside DOMContentLoaded
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, collection, query, where, orderBy, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  // ✅ Wait for DOMContentLoaded for safety
  document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
            apiKey: "AIzaSyDq3uO76nnqqPgPaFfXpOTEnFSXRqXneWU",
            authDomain: "fika-connect-5f844.firebaseapp.com",
            projectId: "fika-connect-5f844",
            storageBucket: "fika-connect-5f844.appspot.com",
            messagingSenderId: "124223307329",
            appId: "1:124223307329:web:76c547b91dcd25205550c0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const logoutBtnSidebar = document.getElementById('logoutBtnSidebar');
        const userNameDisplay = document.getElementById('userNameDisplay');
        const pendingDeliveriesCount = document.getElementById('pendingDeliveriesCount');
        const completedDeliveriesCount = document.getElementById('completedDeliveriesCount');
        const totalSpendAmount = document.getElementById('totalSpendAmount');
        const deliveriesList = document.getElementById('deliveriesList');
        const loadingDeliveries = document.getElementById('loadingDeliveries');
        const noDeliveriesMessage = document.getElementById('noDeliveriesMessage');
        const errorMessageDiv = document.getElementById('errorMessage');

        // Added missing DOM element references for the sidebar to fix ReferenceErrors
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
       // const overlay = document.getElementById('overlay');

        // --- Global Variables ---
        let CURRENT_SENDER_ID = null;
        const activeTrackingMaps = {};

        // --- Event Listeners ---
        if (logoutBtnSidebar) {
            logoutBtnSidebar.addEventListener('click', async (e) => {
                e.preventDefault();
                cleanupTrackingMaps();
                await signOut(auth);
                window.location.href = 'login.html';
            });
        }

        // Added checks to ensure sidebar elements exist before adding listeners
        if (menuToggle && sidebar && overlay) {
            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            });
            overlay.addEventListener('click', () => {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            });
        }

        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                CURRENT_SENDER_ID = user.uid;
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        userNameDisplay.textContent = userDocSnap.data().name || "Sender";
                    } else {
                        console.warn("User document not found for:", user.uid);
                        userNameDisplay.textContent = "Sender";
                    }
                } catch (error) {
                    console.error("Error fetching user name:", error);
                    userNameDisplay.textContent = "Sender";
                }
                fetchAndDisplayDeliveries();
            } else {
                cleanupTrackingMaps();
                window.location.href = 'login.html';
            }
        });

        // --- Fetch and Display Deliveries ---
        async function fetchAndDisplayDeliveries() {
            loadingDeliveries.style.display = 'block';
            deliveriesList.innerHTML = '';
            noDeliveriesMessage.style.display = 'none';
            errorMessageDiv.style.display = 'none';
            errorMessageDiv.textContent = '';

            if (!CURRENT_SENDER_ID) {
                errorMessageDiv.textContent = "Error: Sender ID not available.";
                errorMessageDiv.style.display = 'block';
                loadingDeliveries.style.display = 'none';
                return;
            }

            try {
                const bookingsRef = collection(db, "bookings");
                const q = query(
                    bookingsRef,
                    where("customerId", "==", CURRENT_SENDER_ID),
                    orderBy("bookingDate", "desc")
                );

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    let pendingCount = 0;
                    let completedCount = 0;
                    let totalSpend = 0;
                    deliveriesList.innerHTML = '';
                    cleanupTrackingMaps();

                    if (snapshot.empty) {
                        noDeliveriesMessage.style.display = 'block';
                        pendingDeliveriesCount.textContent = 0;
                        completedDeliveriesCount.textContent = 0;
                        totalSpendAmount.textContent = 0;
                        loadingDeliveries.style.display = 'none';
                        return;
                    }

                    snapshot.docs.forEach(doc => {
                        const booking = doc.data();
                        const bookingId = doc.id;

                        const status = booking.status ? booking.status.toLowerCase() : '';
                        if (status === 'completed' || status === 'cancelled') {
                            completedCount++;
                        } else {
                            pendingCount++;
                        }
                        if (booking.paymentStatus === 'Paid' && typeof booking.fareAmount === 'number') {
                            totalSpend += booking.fareAmount;
                        }

                        deliveriesList.appendChild(createDeliveryCard(booking, bookingId));

                        if (booking.assignedDriver && (status !== 'completed' && status !== 'cancelled')) {
                            initializeTrackingMap(
                                bookingId,
                                booking.assignedDriver,
                                booking.pickupLocation,
                                booking.dropoffLocation
                            );
                        }
                    });

                    pendingDeliveriesCount.textContent = pendingCount;
                    completedDeliveriesCount.textContent = completedCount;
                    totalSpendAmount.textContent = totalSpend.toLocaleString('en-UG');

                    loadingDeliveries.style.display = 'none';
                    noDeliveriesMessage.style.display = 'none';
                }, (error) => {
                    console.error("Error fetching deliveries:", error);
                    errorMessageDiv.textContent = `Error loading deliveries: ${error.message}`;
                    errorMessageDiv.style.display = 'block';
                    loadingDeliveries.style.display = 'none';
                });
            } catch (error) {
                console.error("Failed to set up delivery listener:", error);
                errorMessageDiv.textContent = `Failed to set up delivery listener: ${error.message}`;
                errorMessageDiv.style.display = 'block';
                loadingDeliveries.style.display = 'none';
            }
        }

        function createDeliveryCard(booking, bookingId) {
            const card = document.createElement('div');
            card.className = 'delivery-card';
            const statusClass = booking.status ? booking.status.toLowerCase().replace(/\s/g, '-') : 'pending';

            const parcelType = booking.parcelDetails?.type || 'N/A';
            const parcelWeight = booking.parcelDetails?.weightKg ? `${booking.parcelDetails.weightKg} kg` : 'N/A';
            const isFragile = booking.parcelDetails?.isFragile ? 'Yes' : 'No';

            const pickupName = booking.pickupLocation?.name || 'N/A';
            const dropoffName = booking.dropoffLocation?.name || 'N/A';

            const recipientName = booking.recipient?.name || 'N/A';
            const recipientContact = booking.recipient?.contact || 'N/A';

            let formattedBookingDate = 'N/A';
            if (booking.bookingDate && typeof booking.bookingDate.toDate === 'function') {
                formattedBookingDate = booking.bookingDate.toDate().toLocaleDateString('en-UG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else if (booking.bookingDate instanceof Date) {
                formattedBookingDate = booking.bookingDate.toLocaleDateString('en-UG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } else if (typeof booking.bookingDate === 'string') {
                try {
                    formattedBookingDate = new Date(booking.bookingDate).toLocaleDateString('en-UG', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    console.warn("Could not parse bookingDate string:", booking.bookingDate);
                }
            }

            card.innerHTML = `
                <div class="delivery-card-header">
                    <h4>Booking #${bookingId.substring(0, 8)}</h4>
                    <span class="status-badge ${statusClass}">${booking.status || 'Pending'}</span>
                </div>
                <div class="delivery-details">
                    <div class="detail-item">
                        <strong>Type:</strong> <p>${booking.deliveryType === 'direct_delivery' ? 'Direct Delivery' : 'Collection Point Pickup'}</p>
                    </div>
                    <div class="detail-item">
                        <strong>Fare:</strong> <p>UGX ${typeof booking.fareAmount === 'number' ? booking.fareAmount.toLocaleString('en-UG') : 'N/A'}</p>
                    </div>
                    <div class="detail-item">
                        <strong>Pickup:</strong> <p>${pickupName}</p>
                    </div>
                    <div class="detail-item">
                        <strong>Dropoff:</strong> <p>${dropoffName}</p>
                    </div>
                    <div class="detail-item">
                        <strong>Parcel:</strong> <p>${parcelType}, ${parcelWeight}, Fragile: ${isFragile}</p>
                    </div>
                    <div class="detail-item">
                        <strong>Recipient:</strong> <p>${recipientName} (${recipientContact})</p>
                    </div>
                    <div class="detail-item">
                        <strong>Booked On:</strong> <p>${formattedBookingDate}</p>
                    </div>
                    ${booking.assignedDriver ? `<div class="detail-item"><strong>Driver:</strong> <p>${booking.assignedDriverName || 'Assigned'}</p></div>` : ''}
                </div>
                ${booking.assignedDriver && (status !== 'completed' && status !== 'cancelled') ? `<div class="delivery-map" id="map-${bookingId}"></div>` : ''}
            `;
            return card;
        }

        const driverIcon = L.icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        const locationIcon = L.icon({
            iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        async function initializeTrackingMap(bookingId, driverId, pickupLoc, dropoffLoc) {
            const mapContainer = document.getElementById(`map-${bookingId}`);
            if (!mapContainer || activeTrackingMaps[bookingId]) return;

            const map = L.map(mapContainer).setView([0.3475, 32.5822], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            activeTrackingMaps[bookingId] = { map: map, driverMarker: null, pickupMarker: null, dropoffMarker: null, unsubscribe: null };

            if (pickupLoc && pickupLoc.lat && pickupLoc.lng) {
                activeTrackingMaps[bookingId].pickupMarker = L.marker([pickupLoc.lat, pickupLoc.lng], { icon: locationIcon })
                    .addTo(map)
                    .bindPopup(`Pickup: ${pickupLoc.name || 'N/A'}`);
            }
            if (dropoffLoc && dropoffLoc.lat && dropoffLoc.lng) {
                activeTrackingMaps[bookingId].dropoffMarker = L.marker([dropoffLoc.lat, dropoffLoc.lng], { icon: locationIcon })
                    .addTo(map)
                    .bindPopup(`Dropoff: ${dropoffLoc.name || 'N/A'}`);
            }

            const latLngs = [];
            if (activeTrackingMaps[bookingId].pickupMarker) latLngs.push(activeTrackingMaps[bookingId].pickupMarker.getLatLng());
            if (activeTrackingMaps[bookingId].dropoffMarker) latLngs.push(activeTrackingMaps[bookingId].dropoffMarker.getLatLng());
            if (latLngs.length > 0) {
                map.fitBounds(L.latLngBounds(latLngs).pad(0.5));
            }

            const driverRef = doc(db, "users", driverId);
            const unsubscribe = onSnapshot(driverRef, (docSnap) => {
                if (docSnap.exists()) {
                    const driverData = docSnap.data();
                    const driverLocation = driverData.lastKnownLocation;

                    if (driverLocation && driverLocation.lat && driverLocation.lng) {
                        const driverLatLng = L.latLng(driverLocation.lat, driverLocation.lng);
                        if (activeTrackingMaps[bookingId].driverMarker) {
                            activeTrackingMaps[bookingId].driverMarker.setLatLng(driverLatLng);
                        } else {
                            activeTrackingMaps[bookingId].driverMarker = L.marker(driverLatLng, { icon: driverIcon })
                                .addTo(map)
                                .bindPopup(`Driver: ${driverData.name || 'N/A'}`)
                                .openPopup();
                        }
                    } else {
                        if (activeTrackingMaps[bookingId].driverMarker) {
                            map.removeLayer(activeTrackingMaps[bookingId].driverMarker);
                            activeTrackingMaps[bookingId].driverMarker = null;
                        }
                    }
                } else {
                    console.log(`Driver document for ID ${driverId} does not exist.`);
                    if (activeTrackingMaps[bookingId].driverMarker) {
                        map.removeLayer(activeTrackingMaps[bookingId].driverMarker);
                        activeTrackingMaps[bookingId].driverMarker = null;
                    }
                    if (activeTrackingMaps[bookingId].unsubscribe) {
                        activeTrackingMaps[bookingId].unsubscribe();
                        activeTrackingMaps[bookingId].unsubscribe = null;
                    }
                }
            }, (error) => {
                console.error("Error listening to driver location:", error);
            });

            activeTrackingMaps[bookingId].unsubscribe = unsubscribe;
        }

        function cleanupTrackingMaps() {
            for (const bookingId in activeTrackingMaps) {
                if (activeTrackingMaps[bookingId].unsubscribe) {
                    activeTrackingMaps[bookingId].unsubscribe();
                }
                if (activeTrackingMaps[bookingId].map) {
                    activeTrackingMaps[bookingId].map.remove();
                }
                delete activeTrackingMaps[bookingId];
            }
            console.log("Cleaned up all active tracking maps.");
        }

        // Call cleanup on page unload to prevent memory leaks and unnecessary listeners
        window.addEventListener('beforeunload', cleanupTrackingMaps);
    });
</script>
</body>
</html>
