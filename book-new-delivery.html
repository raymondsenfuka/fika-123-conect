<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book & Track | FikaConnect</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        /* General Layout */
        .initial-view {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        #currentLocationMap {
            height: 400px;
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            background-color: #fff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 40px auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 20px);
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color 0.3s ease;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="email"]:focus,
        .form-group input[type="tel"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .form-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }

        .form-actions .primary-btn,
        .form-actions .secondary-btn {
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            border: none;
        }

        .form-actions .primary-btn {
            background-color: var(--primary-color);
            color: #fff;
        }

        .form-actions .primary-btn:hover {
            background-color: var(--dark-text);
            transform: translateY(-2px);
        }

        .form-actions .secondary-btn {
            background-color: #f0f0f0;
            color: #555;
            border: 1px solid #ccc;
        }

        .form-actions .secondary-btn:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }

        .fare-display {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--primary-color);
            text-align: right;
        }

        .fare-display span {
            font-size: 1.6em;
            color: var(--accent-color);
            margin-left: 10px;
        }

        .payment-options {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px dashed #eee;
        }

        .payment-options h4 {
            font-size: 1.5em;
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .payment-methods {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .payment-method-card {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 180px;
        }

        .payment-method-card:hover,
        .payment-method-card.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.2);
            background-color: #e6f7ff;
        }

        .payment-method-card i {
            font-size: 3em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .payment-method-card p {
            font-weight: 600;
            color: #333;
        }

        .booking-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-weight: 600;
            text-align: center;
            display: none; /* Hidden by default */
        }

        .booking-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .booking-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .booking-message.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .tab-navigation {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #eee;
        }

        .tab-button {
            background-color: #f5f5f5;
            padding: 15px 25px;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: #555;
            border-radius: 8px 8px 0 0;
            margin: 0 5px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .tab-button.active {
            background-color: var(--primary-color);
            color: #fff;
            border-bottom: 2px solid var(--primary-color);
            transform: translateY(2px);
        }

        .tab-button:hover:not(.active) {
            background-color: #e0e0e0;
        }

        .tab-content {
            display: none; /* Hidden by default */
        }

        .tab-content.active {
            display: block;
        }

        .distance-display {
            font-size: 1.1em;
            color: #555;
            margin-top: 10px;
            text-align: center;
            font-weight: 600;
        }
        .distance-display.error {
            color: #dc3545;
        }

        /* NEW: Skip button styling */
        .skip-button-container {
            margin-top: 30px;
            text-align: center;
        }

        /* Ensure initial view and booking form display correctly */
        #initialView {
            display: block; /* Show this by default on load */
        }
        #bookingFormContainer {
            display: none; /* Hide this by default on load */
        }
    </style>
</head>
<body>

    <header class="page-header">
        <div class="container">
            <h1><a href="landing.html">FikaConnect</a></h1>
            <nav class="main-nav">
                <a href="sender-dashboard.html">Dashboard</a>
                <a href="book-and-track.html">Book New</a>
                <a href="about.html">About Us</a>
                <a href="#" id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </nav>
        </div>
    </header>

    <main class="container">
        <div id="initialView" class="initial-view">
            <h2>Book Your Delivery</h2>
            <p>We'll try to find your current location to help with pickup, or you can skip this step.</p>
            <h3><i class="fas fa-map-marker-alt"></i> Your Current Location</h3>
            <div id="currentLocationMap"></div>
            <p id="locationStatus" class="small-text">Getting your location...</p>
            <div class="skip-button-container">
                <button type="button" id="skipLocationBtn" class="secondary-btn"><i class="fas fa-arrow-right"></i> Skip Location Selection</button>
            </div>
        </div>

        <div id="bookingFormContainer" class="form-section">
            <div class="tab-navigation">
                <button class="tab-button active" data-tab="direct">Direct Delivery</button>
                <button class="tab-button" data-tab="collection-point">Collection Point Delivery</button>
            </div>

            <div id="direct" class="tab-content active">
                <form id="directDeliveryForm">
                    <h3>Pickup Details</h3>
                    <div class="form-group">
                        <label for="pickupLocation">Pickup Location:</label>
                        <input type="text" id="pickupLocation" placeholder="Enter pickup address" required>
                    </div>
                    <div class="form-group">
                        <label for="pickupContactName">Contact Name:</label>
                        <input type="text" id="pickupContactName" placeholder="Sender's name" required>
                    </div>
                    <div class="form-group">
                        <label for="pickupContactPhone">Contact Phone:</label>
                        <input type="tel" id="pickupContactPhone" placeholder="+256XXXXXXXXX" required>
                    </div>

                    <h3>Drop-off Details</h3>
                    <div class="form-group">
                        <label for="dropoffLocation">Drop-off Location:</label>
                        <input type="text" id="dropoffLocation" placeholder="Enter drop-off address" required>
                    </div>
                    <div class="form-group">
                        <label for="recipientName">Recipient Name:</label>
                        <input type="text" id="recipientName" placeholder="Recipient's name" required>
                    </div>
                    <div class="form-group">
                        <label for="recipientContact">Recipient Phone:</label>
                        <input type="tel" id="recipientContact" placeholder="+256XXXXXXXXX" required>
                    </div>

                    <h3>Parcel Details</h3>
                    <div class="form-group">
                        <label for="parcelType">Parcel Type:</label>
                        <select id="parcelType" required>
                            <option value="">Select parcel type</option>
                            <option value="Documents">Documents</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothes">Clothes</option>
                            <option value="Food">Food</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="parcelWeight">Weight (kg):</label>
                        <input type="number" id="parcelWeight" placeholder="e.g., 2.5" step="0.1" min="0.1" required>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="isFragile">
                        <label for="isFragile">Is Fragile?</label>
                    </div>
                </form>
            </div>

            <div id="collection-point" class="tab-content">
                <form id="collectionPointDeliveryForm">
                    <h3>Sender Details (Collection Point)</h3>
                    <div class="form-group">
                        <label for="cpSenderName">Your Name:</label>
                        <input type="text" id="cpSenderName" placeholder="Your name" required>
                    </div>
                    <div class="form-group">
                        <label for="cpSenderContact">Your Phone:</label>
                        <input type="tel" id="cpSenderContact" placeholder="+256XXXXXXXXX" required>
                    </div>
                    <div class="form-group">
                        <label for="cpPickupLocation">Pickup Collection Point:</label>
                        <input type="text" id="cpPickupLocation" placeholder="Enter collection point" required>
                    </div>

                    <h3>Recipient Details (Collection Point)</h3>
                    <div class="form-group">
                        <label for="cpRecipientName">Recipient Name:</label>
                        <input type="text" id="cpRecipientName" placeholder="Recipient's name" required>
                    </div>
                    <div class="form-group">
                        <label for="cpRecipientContact">Recipient Phone:</label>
                        <input type="tel" id="cpRecipientContact" placeholder="+256XXXXXXXXX" required>
                    </div>
                    <div class="form-group">
                        <label for="cpDropoffLocation">Drop-off Collection Point:</label>
                        <input type="text" id="cpDropoffLocation" placeholder="Enter drop-off collection point" required>
                    </div>

                    <h3>Parcel Details (Collection Point)</h3>
                    <div class="form-group">
                        <label for="cpParcelType">Parcel Type:</label>
                        <select id="cpParcelType" required>
                            <option value="">Select parcel type</option>
                            <option value="Documents">Documents</option>
                            <option value="Electronics">Electronics</option>
                            <option value="Clothes">Clothes</option>
                            <option value="Food">Food</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="cpParcelWeight">Weight (kg):</label>
                        <input type="number" id="cpParcelWeight" placeholder="e.g., 2.5" step="0.1" min="0.1" required>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="cpIsFragile">
                        <label for="cpIsFragile">Is Fragile?</label>
                    </div>
                </form>
            </div>

            <div id="bookingMessage" class="booking-message" style="display: none;"></div>

            <div class="form-actions">
                <button type="button" id="calculatePriceBtn" class="secondary-btn"><i class="fas fa-calculator"></i> Calculate Fare</button>
                <div class="fare-display">
                    Fare: <span id="fareAmount">UGX 0</span>
                </div>
                <button type="submit" id="bookNowBtn" class="primary-btn" disabled><i class="fas fa-truck-fast"></i> Book Now</button>
            </div>
        </div>
    </main>

    <footer class="page-footer">
        <div class="container">
            <p>&copy; 2025 FikaConnect — Smart Logistics for East Africa</p>
        </div>
    </footer>

    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE&libraries=geometry,geocoding&callback=initMap" async defer></script>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        // REPLACE WITH YOUR ACTUAL FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDq3uO76nnqqPgPaFfXpOTEnFSXRqXneWU", // Ensure this is your correct Firebase API key
        authDomain: "fika-connect-5f844.firebaseapp.com",
        projectId: "fika-connect-5f844",
        storageBucket: "fika-connect-5f844.appspot.com",
        messagingSenderId: "124223307329",
        appId: "1:124223307329:web:76c547b91dcd25205550c0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements (Initial View) ---
        const initialView = document.getElementById('initialView');
        const currentLocationMap = document.getElementById('currentLocationMap');
        const locationStatus = document.getElementById('locationStatus');
        const skipLocationBtn = document.getElementById('skipLocationBtn');
        const bookingFormContainer = document.getElementById('bookingFormContainer'); // The container for the tabs and forms

        // --- DOM Elements (Direct Delivery) ---
        const directDeliveryForm = document.getElementById('directDeliveryForm');
        const pickupLocationInput = document.getElementById('pickupLocation');
        const dropoffLocationInput = document.getElementById('dropoffLocation');
        const pickupContactNameInput = document.getElementById('pickupContactName');
        const pickupContactPhoneInput = document.getElementById('pickupContactPhone');
        const recipientNameInput = document.getElementById('recipientName');
        const recipientContactInput = document.getElementById('recipientContact');
        const parcelTypeInput = document.getElementById('parcelType');
        const parcelWeightInput = document.getElementById('parcelWeight');
        const isFragileCheckbox = document.getElementById('isFragile');

        // --- DOM Elements (Collection Point Delivery) ---
        const collectionPointDeliveryForm = document.getElementById('collectionPointDeliveryForm');
        const cpSenderNameInput = document.getElementById('cpSenderName');
        const cpSenderContactInput = document.getElementById('cpSenderContact');
        const cpPickupLocationInput = document.getElementById('cpPickupLocation');
        const cpRecipientNameInput = document.getElementById('cpRecipientName');
        const cpRecipientContactInput = document.getElementById('cpRecipientContact');
        const cpDropoffLocationInput = document.getElementById('cpDropoffLocation');
        const cpParcelTypeInput = document.getElementById('cpParcelType');
        const cpParcelWeightInput = document.getElementById('cpParcelWeight');
        const cpIsFragileCheckbox = document.getElementById('cpIsFragile');

        // --- Common DOM Elements ---
        const logoutBtn = document.getElementById('logoutBtn');
        const calculatePriceBtn = document.getElementById('calculatePriceBtn');
        const fareAmountSpan = document.getElementById('fareAmount');
        const bookNowBtn = document.getElementById('bookNowBtn');
        const bookingMessageDiv = document.getElementById('bookingMessage');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // --- Global Variables ---
        let CURRENT_USER_ID = null;
        let CURRENT_USER_NAME = "Sender";
        let CURRENT_USER_CONTACT = "";
        let selectedDeliveryType = 'direct_delivery'; // Default delivery type
        let calculatedFare = 0;
        let calculatedDistanceKm = 0;
        let distanceService; // Google Maps Distance Matrix Service
        let geocoderService; // Google Maps Geocoder Service
        let leafletMap = null; // For the initial Leaflet map

        // --- Event Listeners ---
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                await signOut(auth);
                window.location.href = 'login.html';
            });
        }

        // --- NEW: Skip Location Button Event Listener ---
        skipLocationBtn.addEventListener('click', handleSkipLocation);

        // --- Calculate Price Button Event Listener ---
        calculatePriceBtn.addEventListener('click', calculatePrice);

        // --- Booking Button Event Listener ---
        bookNowBtn.addEventListener('click', async (event) => {
            event.preventDefault(); // Prevent default form submission

            let formIsValid = false;
            if (selectedDeliveryType === 'direct_delivery') {
                formIsValid = directDeliveryForm.checkValidity();
            } else {
                formIsValid = collectionPointDeliveryForm.checkValidity();
            }

            if (!formIsValid) {
                if (selectedDeliveryType === 'direct_delivery') directDeliveryForm.reportValidity();
                else collectionPointDeliveryForm.reportValidity();
                showBookingMessage("Please fill in all required fields.", 'error');
                return;
            }

            if (calculatedFare <= 0) {
                showBookingMessage("Please calculate the fare first. Fare cannot be zero.", 'error');
                return;
            }

            bookNowBtn.disabled = true;
            const originalText = bookNowBtn.innerHTML;
            bookNowBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Booking...';

            try {
                await bookDelivery();
                showBookingMessage("Delivery booked successfully! Redirecting...", 'success');
                // Store calculatedFare for the confirm-booking page
                sessionStorage.setItem('fikaConnectBookingFare', calculatedFare.toString());
                setTimeout(() => {
                    window.location.href = 'confirm-booking.html'; // Or sender-dashboard.html
                }, 2000);
            } catch (error) {
                console.error("Error booking delivery:", error);
                showBookingMessage("Failed to book delivery. Please try again. Error: " + error.message, 'error');
                bookNowBtn.disabled = false;
                bookNowBtn.innerHTML = originalText;
            }
        });

        // --- Tab Navigation ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                button.classList.add('active');
                const targetTab = document.getElementById(button.dataset.tab);
                if (targetTab) {
                    targetTab.classList.add('active');
                    selectedDeliveryType = button.dataset.tab === 'direct' ? 'direct_delivery' : 'collection_point_pickup';
                    resetFareAndBooking(); // Reset fare when changing tabs
                }
            });
        });

        // --- Authentication State Listener ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                CURRENT_USER_ID = user.uid;
                console.log("Firebase: User is logged in, UID:", user.uid);
                // Fetch user's name and contact for auto-filling sender details
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        CURRENT_USER_NAME = userData.name || "Sender";
                        CURRENT_USER_CONTACT = userData.contact || "";

                        // Auto-fill sender details if they exist and fields are empty
                        if (pickupContactNameInput.value === "") pickupContactNameInput.value = CURRENT_USER_NAME;
                        if (pickupContactPhoneInput.value === "") pickupContactPhoneInput.value = CURRENT_USER_CONTACT;
                        
                        if (cpSenderNameInput.value === "") cpSenderNameInput.value = CURRENT_USER_NAME;
                        if (cpSenderContactInput.value === "") cpSenderContactInput.value = CURRENT_USER_CONTACT;
                    }
                    console.log("Firebase: User data fetched and sender fields auto-filled.");
                } catch (error) {
                    console.error("Firebase: Error fetching user details:", error);
                }
                // Initialize map after user is authenticated
                getLocationAndInitMap();
            } else {
                console.log("Firebase: User not logged in, redirecting to login.html");
                window.location.href = 'login.html'; // Redirect to login if not authenticated
            }
        });

        // --- Google Maps API Initialization (Global Callback) ---
        // This function is called automatically by the Google Maps script once it's loaded.
        window.initMap = function() {
            console.log("Google Maps API: initMap callback fired. Initializing services...");
            distanceService = new google.maps.DistanceMatrixService();
            geocoderService = new google.maps.Geocoder(); // Initialize Geocoder Service
            console.log("Google Maps API: DistanceMatrixService and Geocoder initialized.");

            // Add input event listeners to trigger recalculation
            parcelTypeInput.addEventListener('change', calculatePrice);
            parcelWeightInput.addEventListener('input', calculatePrice);
            isFragileCheckbox.addEventListener('change', calculatePrice);

            cpParcelTypeInput.addEventListener('change', calculatePrice);
            cpParcelWeightInput.addEventListener('input', calculatePrice);
            cpIsFragileCheckbox.addEventListener('change', calculatePrice);
        };

        // --- Geocoding Helper Function ---
        async function geocodeAddress(address) {
            console.log("Geocoding: Attempting to geocode address:", address);
            return new Promise((resolve, reject) => {
                if (!geocoderService) {
                    console.error("Geocoding: Geocoder service is not initialized.");
                    reject(new Error("Geocoder service not initialized. Google Maps API might not be loaded or its initMap callback hasn't fired."));
                    return;
                }
                geocoderService.geocode({ 'address': address, 'componentRestrictions': { 'country': 'UG' } }, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        console.log("Geocoding: Successfully geocoded", address, "to", results[0].formatted_address);
                        resolve({
                            lat: results[0].geometry.location.lat(),
                            lng: results[0].geometry.location.lng(),
                            formatted_address: results[0].formatted_address
                        });
                    } else {
                        console.error("Geocoding: Failed to geocode", address, "Status:", status);
                        reject(new Error(`Geocoding failed for ${address}: ${status}`));
                    }
                });
            });
        }

        // --- Calculate Price Function (Modified for Geocoding) ---
        async function calculatePrice() {
            console.log("Calculate Price: Function called.");
            resetFareAndBooking(); // Reset fare and disable button initially

            let originAddress, destinationAddress;
            let parcelWeight, parcelType, isFragile;
            let currentFormIsValid = true;

            if (selectedDeliveryType === 'direct_delivery') {
                originAddress = pickupLocationInput.value.trim();
                destinationAddress = dropoffLocationInput.value.trim();
                parcelWeight = parseFloat(parcelWeightInput.value);
                parcelType = parcelTypeInput.value;
                isFragile = isFragileCheckbox.checked;

                if (!originAddress || !destinationAddress || isNaN(parcelWeight) || parcelWeight <= 0 || !parcelType || !pickupContactNameInput.value || !pickupContactPhoneInput.value || !recipientNameInput.value || !recipientContactInput.value) {
                    currentFormIsValid = false;
                }

            } else { // collection_point_pickup
                originAddress = cpPickupLocationInput.value.trim();
                destinationAddress = cpDropoffLocationInput.value.trim();
                parcelWeight = parseFloat(cpParcelWeightInput.value);
                parcelType = cpParcelTypeInput.value;
                isFragile = cpIsFragileCheckbox.checked;

                if (!originAddress || !destinationAddress || isNaN(parcelWeight) || parcelWeight <= 0 || !parcelType || !cpSenderNameInput.value || !cpSenderContactInput.value || !cpRecipientNameInput.value || !cpRecipientContactInput.value) {
                    currentFormIsValid = false;
                }
            }
            
            if (!currentFormIsValid) {
                fareAmountSpan.textContent = `UGX 0`;
                showBookingMessage("Please fill in all required fields to calculate fare.", 'info');
                console.log("Calculate Price: Form not fully valid for calculation.");
                return;
            }

            // --- Check if Google Maps Services are ready ---
            if (!geocoderService || !distanceService) {
                const errorMessage = "Google Maps services are not yet initialized. Please check your API key and ensure all required APIs (Maps JavaScript API, Geocoding API, Distance Matrix API) are enabled in your Google Cloud Console.";
                showBookingMessage(errorMessage, 'error');
                fareAmountSpan.textContent = `UGX 0`;
                bookNowBtn.disabled = true;
                console.error("Calculate Price:", errorMessage);
                return;
            }

            calculatePriceBtn.disabled = true;
            const originalBtnText = calculatePriceBtn.innerHTML;
            calculatePriceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculating...';
            fareAmountSpan.textContent = 'Calculating...';
            showBookingMessage("Calculating fare, please wait...", 'info');

            try {
                // --- Geocode Addresses First ---
                console.log("Calculate Price: Starting geocoding for origin and destination.");
                const originCoords = await geocodeAddress(originAddress);
                const destinationCoords = await geocodeAddress(destinationAddress);
                console.log("Calculate Price: Geocoding successful. Calculating distance.");

                // --- Get Distance using Google Maps Distance Matrix Service ---
                const response = await new Promise((resolve, reject) => {
                    distanceService.getDistanceMatrix(
                        {
                            origins: [{lat: originCoords.lat, lng: originCoords.lng}],
                            destinations: [{lat: destinationCoords.lat, lng: destinationCoords.lng}],
                            travelMode: google.maps.TravelMode.DRIVING,
                            unitSystem: google.maps.UnitSystem.METRIC,
                            avoidHighways: false,
                            avoidTolls: false,
                        },
                        (res, status) => {
                            if (status === 'OK') {
                                resolve(res);
                            } else {
                                reject(new Error('Distance Matrix error: ' + status));
                            }
                        }
                    );
                });

                const element = response.rows[0].elements[0];
                if (element.status === 'OK') {
                    calculatedDistanceKm = element.distance.value / 1000; // Distance in kilometers
                    console.log(`Calculate Price: Distance: ${calculatedDistanceKm.toFixed(2)} km`);

                    // --- Sample Fare Calculation Logic ---
                    const BASE_FARE = 5000; // UGX
                    const COST_PER_KM = 500; // UGX per kilometer
                    const WEIGHT_SURCHARGE_PER_KG = 200; // UGX per kg
                    const FRAGILE_SURCHARGE = 1000; // UGX for fragile items

                    calculatedFare = BASE_FARE + (calculatedDistanceKm * COST_PER_KM);

                    // Add weight surcharge
                    calculatedFare += (parcelWeight * WEIGHT_SURCHARGE_PER_KG);

                    // Add fragile surcharge
                    if (isFragile) {
                        calculatedFare += FRAGILE_SURCHARGE;
                    }

                    // Adjust for parcel type (optional, example)
                    if (parcelType === 'Documents') {
                        calculatedFare -= 500; // Small discount for documents
                    } else if (parcelType === 'Electronics') {
                        calculatedFare += 1500; // Higher cost for electronics
                    }
                    
                    calculatedFare = Math.max(0, Math.round(calculatedFare / 100) * 100); // Round to nearest 100 UGX, no negative fare

                    fareAmountSpan.textContent = `UGX ${calculatedFare.toLocaleString()}`;
                    bookNowBtn.disabled = false; // Enable book button once fare is calculated
                    showBookingMessage(`Fare: UGX ${calculatedFare.toLocaleString()} (Distance: ${calculatedDistanceKm.toFixed(1)} km)`, 'success');
                    console.log("Calculate Price: Fare calculated successfully.");

                } else {
                    console.error("Calculate Price: Distance calculation failed:", element.status);
                    throw new Error('Distance calculation failed: ' + element.status);
                }
            } catch (error) {
                console.error("Calculate Price: Error in calculatePrice execution:", error);
                fareAmountSpan.textContent = `UGX 0`;
                bookNowBtn.disabled = true;
                showBookingMessage("Could not calculate fare. Please ensure addresses are valid and try again. Error: " + error.message, 'error');
            } finally {
                calculatePriceBtn.disabled = false;
                calculatePriceBtn.innerHTML = originalBtnText;
            }
        }

        // Helper to show messages
        function showBookingMessage(message, type) {
            bookingMessageDiv.textContent = message;
            bookingMessageDiv.className = `booking-message ${type}`;
            bookingMessageDiv.style.display = 'block';
            setTimeout(() => {
                bookingMessageDiv.style.display = 'none';
            }, 5000);
        }

        // Helper to reset fare and disable booking button
        function resetFareAndBooking() {
            calculatedFare = 0;
            calculatedDistanceKm = 0;
            fareAmountSpan.textContent = `UGX 0`;
            bookNowBtn.disabled = true;
            bookingMessageDiv.style.display = 'none';
            console.log("Fare and booking button reset.");
        }

        // --- Book Delivery Function ---
        async function bookDelivery() {
            console.log("Book Delivery: Function called.");
            let bookingData = {};
            let customerId = CURRENT_USER_ID;
            let customerName, customerContact;
            let pickupLocation, dropoffLocation;
            let parcelDetails;
            let recipient;

            // Re-geocode addresses to get the latest formatted address and coordinates
            let originCoords, destinationCoords;

            try {
                if (selectedDeliveryType === 'direct_delivery') {
                    originCoords = await geocodeAddress(pickupLocationInput.value);
                    destinationCoords = await geocodeAddress(dropoffLocationInput.value);

                    pickupLocation = {
                        name: originCoords.formatted_address,
                        lat: originCoords.lat,
                        lng: originCoords.lng
                    };
                    dropoffLocation = {
                        name: destinationCoords.formatted_address,
                        lat: destinationCoords.lat,
                        lng: destinationCoords.lng
                    };
                    parcelDetails = {
                        type: parcelTypeInput.value,
                        weightKg: parseFloat(parcelWeightInput.value),
                        isFragile: isFragileCheckbox.checked
                    };
                    recipient = {
                        name: recipientNameInput.value,
                        contact: recipientContactInput.value
                    };
                    customerName = pickupContactNameInput.value;
                    customerContact = pickupContactPhoneInput.value;


                } else { // collection_point_pickup
                    originCoords = await geocodeAddress(cpPickupLocationInput.value);
                    destinationCoords = await geocodeAddress(cpDropoffLocationInput.value);

                    pickupLocation = {
                        name: originCoords.formatted_address,
                        lat: originCoords.lat,
                        lng: originCoords.lng
                    };
                    dropoffLocation = {
                        name: destinationCoords.formatted_address,
                        lat: destinationCoords.lat,
                        lng: destinationCoords.lng
                    };
                    parcelDetails = {
                        type: cpParcelTypeInput.value,
                        weightKg: parseFloat(cpParcelWeightInput.value),
                        isFragile: cpIsFragileCheckbox.checked
                    };
                    recipient = {
                        name: cpRecipientNameInput.value,
                        contact: cpRecipientContactInput.value
                    };
                    customerName = cpSenderNameInput.value;
                    customerContact = cpSenderContactInput.value;
                }

                bookingData = {
                    customerId: customerId,
                    customerName: customerName,
                    customerContact: customerContact,
                    deliveryType: selectedDeliveryType,
                    pickupLocation: pickupLocation,
                    dropoffLocation: dropoffLocation,
                    parcelDetails: parcelDetails,
                    recipient: recipient,
                    fareAmount: calculatedFare,
                    distanceKm: calculatedDistanceKm,
                    status: "Pending Driver Assignment",
                    paymentStatus: "Pending", // Payment is handled on confirm-booking.html
                    bookingDate: serverTimestamp()
                };

                // Store this data in sessionStorage for the confirm-booking.html page
                sessionStorage.setItem('fikaConnectBookingData', JSON.stringify(bookingData));
                console.log("Book Delivery: Booking data stored in sessionStorage:", bookingData);
                await addDoc(collection(db, "bookings"), bookingData);
                console.log("Book Delivery: Booking successfully added to Firestore.");

            } catch (error) {
                console.error("Book Delivery: Error during booking process (geocoding or firestore addDoc):", error);
                throw error; // Re-throw to be caught by the bookNowBtn event listener
            }
        }

        // --- NEW: Handle Skip Location Function ---
        function handleSkipLocation() {
            console.log("Skip Location: Button clicked. Hiding initial view, showing booking form.");
            initialView.style.display = 'none';
            bookingFormContainer.style.display = 'block';
        }

        // --- Initial Map & Location (Leaflet) ---
        function getLocationAndInitMap() {
            console.log("Leaflet Map: getLocationAndInitMap called.");
            if (navigator.geolocation) {
                locationStatus.textContent = "Attempting to get your location...";
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log("Leaflet Map: Geolocation successful.");
                        const latLng = { lat: position.coords.latitude, lng: position.coords.longitude };
                        initLeafletMap(latLng);
                        locationStatus.textContent = "Your approximate location is displayed.";
                    },
                    (error) => {
                        console.error("Leaflet Map: Geolocation error:", error);
                        let errorMessage = "Could not get your location. Please allow location access.";
                        if (error.code === error.PERMISSION_DENIED) {
                            errorMessage = "Location access denied. Defaulting to Kampala.";
                        } else if (error.code === error.POSITION_UNAVAILABLE) {
                            errorMessage = "Location information unavailable. Defaulting to Kampala.";
                        } else if (error.code === error.TIMEOUT) {
                            errorMessage = "Location request timed out. Defaulting to Kampala.";
                        }
                        locationStatus.textContent = errorMessage;
                        initLeafletMap({ lat: 0.347596, lng: 32.582520 }); // Default to Kampala
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                console.warn("Leaflet Map: Geolocation is not supported by this browser.");
                locationStatus.textContent = "Geolocation is not supported by your browser. Defaulting to Kampala.";
                initLeafletMap({ lat: 0.347596, lng: 32.582520 }); // Default to Kampala
            }
        }

        function initLeafletMap(latLng) {
            console.log("Leaflet Map: Initializing Leaflet map at", latLng);
            if (leafletMap) {
                leafletMap.remove(); // Remove existing map if any
            }
            // Ensure the map container is visible and has dimensions before initializing
            currentLocationMap.style.height = '400px'; // Set a height if it's dynamically changed
            leafletMap = L.map('currentLocationMap').setView([latLng.lat, latLng.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(leafletMap);

            L.marker([latLng.lat, latLng.lng]).addTo(leafletMap)
                .bindPopup("Your approximate location").openPopup();
            console.log("Leaflet Map: Map initialized successfully.");
        }

        // Call getLocationAndInitMap only after Firebase authentication state is determined
        // (This is already handled by onAuthStateChanged)
    </script>
</body>
</html>